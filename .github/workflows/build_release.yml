name: Build release
run-name: Bulding release ${{github.ref_name}} 🪚

on:
   release:
      types: [published]
permissions:
  contents: write
env:
  VERSION: ${{github.ref_name}}

jobs:   
  building:
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest
        type:
          - bundle
          - app
    
    runs-on: ${{matrix.os}}

    steps: 
      - name: Setup repo
        uses: actions/checkout@v4

      - name: Setup flutter on ${{matrix.os}}
        uses: subosito/flutter-action@v2 
        with:
          channel: stable
          flutter-version: '3.16.9'
          cache: true

      - name: Install dependecies
        run: flutter pub get

      - name: Run lint checks
        run: flutter analyze

      - name: Build android apk 🤖.
        if: ${{matrix.os == 'ubuntu-latest' && matrix.type == 'app'}}
        run: flutter build apk
      
      - name: Build android bundle 🤖.
        if: ${{matrix.os == 'ubuntu-latest' && matrix.type == 'bundle'}}
        run: flutter build appbundle --build-name $VERSION

      - name: Build ios app 🍎.
        if: ${{matrix.os == 'macos-latest' && matrix.type == 'app'}}
        run: flutter build ios --release --no-codesign --build-name $VERSION

      - name: Build ios bundle 🍎.
        if: ${{matrix.os == 'macos-latest' && matrix.type == 'bundle'}}
        run: flutter build ipa --build-name $VERSION 

      - name: Include android App in github release 📦.
        uses: softprops/action-gh-release@v2
        if: ${{matrix.os == 'ubuntu-latest' && matrix.type == 'app'}}
        with: 
          files: './build/app/outputs/flutter-apk/-release.apk'
          prerelease: false
          generate_release_notes: false
          make_latest: false

      - name: Include android bundle in github release 📦.
        uses: softprops/action-gh-release@v2
        if: ${{matrix.os == 'ubuntu-latest' && matrix.type == 'bundle'}}
        with:
          files: './build/app/outputs/bundle/release/app-release.aab'

      - name: Include ios app in github release .
        uses: softprops/action-gh-release@v2
        if: ${{matrix.os == 'macos-latest' && matrix.type == 'app'}}
        with:
          files: './build/ios/iphoneos/Runner.app'
